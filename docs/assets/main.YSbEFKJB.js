var dr=Object.defineProperty;var Ot=e=>{throw TypeError(e)};var hr=(e,t,i)=>t in e?dr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var l=(e,t,i)=>hr(e,typeof t!="symbol"?t+"":t,i),Ve=(e,t,i)=>t.has(e)||Ot("Cannot "+i);var n=(e,t,i)=>(Ve(e,t,"read from private field"),i?i.call(e):t.get(e)),A=(e,t,i)=>t.has(e)?Ot("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,i),d=(e,t,i,s)=>(Ve(e,t,"write to private field"),s?s.call(e,i):t.set(e,i),i),h=(e,t,i)=>(Ve(e,t,"access private method"),i);import{W as Bt}from"./store.B0ay3j7c.js";/* empty css              */var we={},qt;function gr(){if(qt)return we;qt=1,we.byteLength=u,we.toByteArray=b,we.fromByteArray=I;for(var e=[],t=[],i=typeof Uint8Array<"u"?Uint8Array:Array,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r=0,a=s.length;r<a;++r)e[r]=s[r],t[s.charCodeAt(r)]=r;t[45]=62,t[95]=63;function g(T){var m=T.length;if(m%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var U=T.indexOf("=");U===-1&&(U=m);var E=U===m?0:4-U%4;return[U,E]}function u(T){var m=g(T),U=m[0],E=m[1];return(U+E)*3/4-E}function y(T,m,U){return(m+U)*3/4-U}function b(T){var m,U=g(T),E=U[0],R=U[1],q=new i(y(T,E,R)),L=0,me=R>0?E-4:E,$;for($=0;$<me;$+=4)m=t[T.charCodeAt($)]<<18|t[T.charCodeAt($+1)]<<12|t[T.charCodeAt($+2)]<<6|t[T.charCodeAt($+3)],q[L++]=m>>16&255,q[L++]=m>>8&255,q[L++]=m&255;return R===2&&(m=t[T.charCodeAt($)]<<2|t[T.charCodeAt($+1)]>>4,q[L++]=m&255),R===1&&(m=t[T.charCodeAt($)]<<10|t[T.charCodeAt($+1)]<<4|t[T.charCodeAt($+2)]>>2,q[L++]=m>>8&255,q[L++]=m&255),q}function S(T){return e[T>>18&63]+e[T>>12&63]+e[T>>6&63]+e[T&63]}function _(T,m,U){for(var E,R=[],q=m;q<U;q+=3)E=(T[q]<<16&16711680)+(T[q+1]<<8&65280)+(T[q+2]&255),R.push(S(E));return R.join("")}function I(T){for(var m,U=T.length,E=U%3,R=[],q=16383,L=0,me=U-E;L<me;L+=q)R.push(_(T,L,L+q>me?me:L+q));return E===1?(m=T[U-1],R.push(e[m>>2]+e[m<<4&63]+"==")):E===2&&(m=(T[U-2]<<8)+T[U-1],R.push(e[m>>10]+e[m>>4&63]+e[m<<2&63]+"=")),R.join("")}return we}var Vt=gr(),v,f,Rt,pe=(Rt=class{constructor(e){A(this,v);A(this,f,0);d(this,v,new DataView(e.buffer)),d(this,f,e.byteOffset)}get offset(){return n(this,f)}readUInt8Array(){const e=this.readU32(),t=new Uint8Array(n(this,v).buffer,n(this,f),e);return d(this,f,n(this,f)+e),t}readBool(){const e=n(this,v).getUint8(n(this,f));return d(this,f,n(this,f)+1),e!==0}readByte(){const e=n(this,v).getUint8(n(this,f));return d(this,f,n(this,f)+1),e}readBytes(e){const t=new DataView(n(this,v).buffer,n(this,f),e);return d(this,f,n(this,f)+e),new Uint8Array(t.buffer)}readI8(){const e=n(this,v).getInt8(n(this,f));return d(this,f,n(this,f)+1),e}readU8(){const e=n(this,v).getUint8(n(this,f));return d(this,f,n(this,f)+1),e}readI16(){const e=n(this,v).getInt16(n(this,f),!0);return d(this,f,n(this,f)+2),e}readU16(){const e=n(this,v).getUint16(n(this,f),!0);return d(this,f,n(this,f)+2),e}readI32(){const e=n(this,v).getInt32(n(this,f),!0);return d(this,f,n(this,f)+4),e}readU32(){const e=n(this,v).getUint32(n(this,f),!0);return d(this,f,n(this,f)+4),e}readI64(){const e=n(this,v).getBigInt64(n(this,f),!0);return d(this,f,n(this,f)+8),e}readU64(){const e=n(this,v).getBigUint64(n(this,f),!0);return d(this,f,n(this,f)+8),e}readU128(){const e=n(this,v).getBigUint64(n(this,f),!0),t=n(this,v).getBigUint64(n(this,f)+8,!0);return d(this,f,n(this,f)+16),(t<<BigInt(64))+e}readI128(){const e=n(this,v).getBigUint64(n(this,f),!0),t=n(this,v).getBigInt64(n(this,f)+8,!0);return d(this,f,n(this,f)+16),(t<<BigInt(64))+e}readU256(){const e=n(this,v).getBigUint64(n(this,f),!0),t=n(this,v).getBigUint64(n(this,f)+8,!0),i=n(this,v).getBigUint64(n(this,f)+16,!0),s=n(this,v).getBigUint64(n(this,f)+24,!0);return d(this,f,n(this,f)+32),(s<<BigInt(3*64))+(i<<BigInt(2*64))+(t<<BigInt(1*64))+e}readI256(){const e=n(this,v).getBigUint64(n(this,f),!0),t=n(this,v).getBigUint64(n(this,f)+8,!0),i=n(this,v).getBigUint64(n(this,f)+16,!0),s=n(this,v).getBigInt64(n(this,f)+24,!0);return d(this,f,n(this,f)+32),(s<<BigInt(3*64))+(i<<BigInt(2*64))+(t<<BigInt(1*64))+e}readF32(){const e=n(this,v).getFloat32(n(this,f),!0);return d(this,f,n(this,f)+4),e}readF64(){const e=n(this,v).getFloat64(n(this,f),!0);return d(this,f,n(this,f)+8),e}readString(){const e=this.readU32(),t=new Uint8Array(n(this,v).buffer,n(this,f),e),s=new TextDecoder("utf-8").decode(t);return d(this,f,n(this,f)+e),s}},v=new WeakMap,f=new WeakMap,Rt),N,C,w,B,P,Nt,ne=(Nt=class{constructor(e){A(this,B);A(this,N);A(this,C);A(this,w,0);d(this,N,new Uint8Array(e)),d(this,C,new DataView(n(this,N).buffer))}toBase64(){return Vt.fromByteArray(n(this,N).subarray(0,n(this,w)))}getBuffer(){return n(this,N).slice(0,n(this,w))}writeUInt8Array(e){const t=e.length;h(this,B,P).call(this,4+t),this.writeU32(t),n(this,N).set(e,n(this,w)),d(this,w,n(this,w)+e.length)}writeBool(e){h(this,B,P).call(this,1),n(this,C).setUint8(n(this,w),e?1:0),d(this,w,n(this,w)+1)}writeByte(e){h(this,B,P).call(this,1),n(this,C).setUint8(n(this,w),e),d(this,w,n(this,w)+1)}writeI8(e){h(this,B,P).call(this,1),n(this,C).setInt8(n(this,w),e),d(this,w,n(this,w)+1)}writeU8(e){h(this,B,P).call(this,1),n(this,C).setUint8(n(this,w),e),d(this,w,n(this,w)+1)}writeI16(e){h(this,B,P).call(this,2),n(this,C).setInt16(n(this,w),e,!0),d(this,w,n(this,w)+2)}writeU16(e){h(this,B,P).call(this,2),n(this,C).setUint16(n(this,w),e,!0),d(this,w,n(this,w)+2)}writeI32(e){h(this,B,P).call(this,4),n(this,C).setInt32(n(this,w),e,!0),d(this,w,n(this,w)+4)}writeU32(e){h(this,B,P).call(this,4),n(this,C).setUint32(n(this,w),e,!0),d(this,w,n(this,w)+4)}writeI64(e){h(this,B,P).call(this,8),n(this,C).setBigInt64(n(this,w),e,!0),d(this,w,n(this,w)+8)}writeU64(e){h(this,B,P).call(this,8),n(this,C).setBigUint64(n(this,w),e,!0),d(this,w,n(this,w)+8)}writeU128(e){h(this,B,P).call(this,16);const t=e&BigInt("0xFFFFFFFFFFFFFFFF"),i=e>>BigInt(64);n(this,C).setBigUint64(n(this,w),t,!0),n(this,C).setBigUint64(n(this,w)+8,i,!0),d(this,w,n(this,w)+16)}writeI128(e){h(this,B,P).call(this,16);const t=e&BigInt("0xFFFFFFFFFFFFFFFF"),i=e>>BigInt(64);n(this,C).setBigInt64(n(this,w),t,!0),n(this,C).setBigInt64(n(this,w)+8,i,!0),d(this,w,n(this,w)+16)}writeU256(e){h(this,B,P).call(this,32);const t=BigInt("0xFFFFFFFFFFFFFFFF"),i=e&t,s=e>>BigInt(64*1)&t,r=e>>BigInt(64*2)&t,a=e>>BigInt(64*3);n(this,C).setBigUint64(n(this,w)+8*0,i,!0),n(this,C).setBigUint64(n(this,w)+8*1,s,!0),n(this,C).setBigUint64(n(this,w)+8*2,r,!0),n(this,C).setBigUint64(n(this,w)+8*3,a,!0),d(this,w,n(this,w)+32)}writeI256(e){h(this,B,P).call(this,32);const t=BigInt("0xFFFFFFFFFFFFFFFF"),i=e&t,s=e>>BigInt(64*1)&t,r=e>>BigInt(64*2)&t,a=e>>BigInt(64*3);n(this,C).setBigUint64(n(this,w)+8*0,i,!0),n(this,C).setBigUint64(n(this,w)+8*1,s,!0),n(this,C).setBigUint64(n(this,w)+8*2,r,!0),n(this,C).setBigInt64(n(this,w)+8*3,a,!0),d(this,w,n(this,w)+32)}writeF32(e){h(this,B,P).call(this,4),n(this,C).setFloat32(n(this,w),e,!0),d(this,w,n(this,w)+4)}writeF64(e){h(this,B,P).call(this,8),n(this,C).setFloat64(n(this,w),e,!0),d(this,w,n(this,w)+8)}writeString(e){const i=new TextEncoder().encode(e);this.writeU32(i.length),h(this,B,P).call(this,i.length),n(this,N).set(i,n(this,w)),d(this,w,n(this,w)+i.length)}},N=new WeakMap,C=new WeakMap,w=new WeakMap,B=new WeakSet,P=function(e){const t=n(this,w)+e+1;if(t<=n(this,N).length)return;let i=n(this,N).length*2;i<t&&(i=t);const s=new Uint8Array(i);s.set(n(this,N)),d(this,N,s),d(this,C,new DataView(n(this,N).buffer))},Nt);function be(e,t){if(e===t)return!0;if(typeof e!="object"||e===null||typeof t!="object"||t===null)return!1;const i=Object.keys(e),s=Object.keys(t);if(i.length!==s.length)return!1;for(let r of i)if(!s.includes(r)||!be(e[r],t[r]))return!1;return!0}function jt(e){return Array.prototype.map.call(e.reverse(),t=>("00"+t.toString(16)).slice(-2)).join("")}function Tr(e){if(e.length!=16)throw new Error(`Uint8Array is not 16 bytes long: ${e}`);return new pe(e).readU128()}function br(e){if(e.length!=32)throw new Error(`Uint8Array is not 32 bytes long: [${e}]`);return new pe(e).readU256()}function Zt(e){e.startsWith("0x")&&(e=e.slice(2));let t=e.match(/.{1,2}/g)||[],i=Uint8Array.from(t.map(s=>parseInt(s,16)));return i.length!=32?new Uint8Array(0):i.reverse()}function fr(e){return Tr(Zt(e))}function mr(e){return br(Zt(e))}function Jt(e){let t=new ne(16);return t.writeU128(e),t.getBuffer()}function wr(e){return jt(Jt(e))}function Gt(e){let t=new ne(32);return t.writeU256(e),t.getBuffer()}function Sr(e){return jt(Gt(e))}var Je=class xe{constructor(t){l(this,"data");this.data=t}get __connection_id__(){return this.data}isZero(){return this.data===BigInt(0)}static nullIfZero(t){return t.isZero()?null:t}static random(){function t(){return Math.floor(Math.random()*255)}let i=BigInt(0);for(let s=0;s<16;s++)i=i<<BigInt(8)|BigInt(t());return new xe(i)}isEqual(t){return this.data==t.data}toHexString(){return wr(this.data)}toUint8Array(){return Jt(this.data)}static fromString(t){return new xe(fr(t))}static fromStringOrNull(t){let i=xe.fromString(t);return i.isZero()?null:i}},j,Ar=(j=class{constructor(t){l(this,"__time_duration_micros__");this.__time_duration_micros__=t}get micros(){return this.__time_duration_micros__}get millis(){return Number(this.micros/j.MICROS_PER_MILLIS)}static fromMillis(t){return new j(BigInt(t)*j.MICROS_PER_MILLIS)}},l(j,"MICROS_PER_MILLIS",1000n),j),H,zr=(H=class{constructor(t){l(this,"__timestamp_micros_since_unix_epoch__");this.__timestamp_micros_since_unix_epoch__=t}get microsSinceUnixEpoch(){return this.__timestamp_micros_since_unix_epoch__}static now(){return H.fromDate(new Date)}static fromDate(t){const i=t.getTime(),s=BigInt(i)*H.MICROS_PER_MILLIS;return new H(s)}toDate(){const i=this.__timestamp_micros_since_unix_epoch__/H.MICROS_PER_MILLIS;if(i>BigInt(Number.MAX_SAFE_INTEGER)||i<BigInt(Number.MIN_SAFE_INTEGER))throw new RangeError("Timestamp is outside of the representable range of JS's Date");return new Date(Number(i))}},l(H,"MICROS_PER_MILLIS",1000n),l(H,"UNIX_EPOCH",new H(0n)),H),Ir=class Xt{constructor(t){l(this,"data");this.data=typeof t=="string"?mr(t):t}get __identity__(){return this.data}isEqual(t){return this.toHexString()===t.toHexString()}toHexString(){return Sr(this.data)}toUint8Array(){return Gt(this.data)}static fromString(t){return new Xt(t)}},Ge;(e=>{function t(){return c.createSumType([new z("Interval",c.createU64Type()),new z("Time",c.createU64Type())])}e.getAlgebraicType=t;function i(r){switch(r.tag){case"Interval":return{Interval:r.value};case"Time":return{Time:r.value};default:throw"unreachable"}}e.serialize=i,e.Interval=r=>({tag:"Interval",value:r}),e.Time=r=>({tag:"Time",value:r});function s(r){let a=r.asSumValue();switch(a.tag){case 0:return{tag:"Interval",value:a.value.asBigInt()};case 1:return{tag:"Time",value:a.value.asBigInt()};default:throw"unreachable"}}e.fromValue=s})(Ge||(Ge={}));var vr=Ge,z=class{constructor(e,t){l(this,"name");l(this,"algebraicType");this.name=e,this.algebraicType=t}},Ur=class{constructor(e){l(this,"variants");l(this,"serialize",(e,t)=>{if(this.variants.length==2&&this.variants[0].name==="some"&&this.variants[1].name==="none")t!=null?(e.writeByte(0),this.variants[0].algebraicType.serialize(e,t)):e.writeByte(1);else{let i=t.tag;const s=this.variants.findIndex(r=>r.name===i);if(s<0)throw`Can't serialize a sum type, couldn't find ${t.tag} tag`;e.writeU8(s),this.variants[s].algebraicType.serialize(e,t.value)}});l(this,"deserialize",e=>{let t=e.readU8();if(this.variants.length==2&&this.variants[0].name==="some"&&this.variants[1].name==="none"){if(t===0)return this.variants[0].algebraicType.deserialize(e);if(t===1)return;throw`Can't deserialize an option type, couldn't find ${t} tag`}else{let i=this.variants[t],s=i.algebraicType.deserialize(e);return{tag:i.name,value:s}}});this.variants=e}},o=class{constructor(e,t){l(this,"name");l(this,"algebraicType");this.name=e,this.algebraicType=t}},_r=class{constructor(e){l(this,"elements");l(this,"serialize",(e,t)=>{for(let i of this.elements)i.algebraicType.serialize(e,t[i.name])});l(this,"deserialize",e=>{let t={};if(this.elements.length===1){if(this.elements[0].name==="__time_duration_micros__")return new Ar(e.readI64());if(this.elements[0].name==="__timestamp_micros_since_unix_epoch__")return new zr(e.readI64());if(this.elements[0].name==="__identity__")return new Ir(e.readU256());if(this.elements[0].name==="__connection_id__")return new Je(e.readU128())}for(let i of this.elements)t[i.name]=i.algebraicType.deserialize(e);return t});this.elements=e}isEmpty(){return this.elements.length===0}intoMapKey(e){if(this.elements.length===1){if(this.elements[0].name==="__time_duration_micros__")return e.__time_duration_micros__;if(this.elements[0].name==="__timestamp_micros_since_unix_epoch__")return e.__timestamp_micros_since_unix_epoch__;if(this.elements[0].name==="__identity__")return e.__identity__;if(this.elements[0].name==="__connection_id__")return e.__connection_id__}const t=new ne(10);return this.serialize(t,e),t.toBase64()}},Cr=class{constructor(e,t){l(this,"keyType");l(this,"valueType");this.keyType=e,this.valueType=t}},D,ce,k,ee,x,Xe,Ye,Qe,c=(ee=class{constructor(){A(this,D);l(this,"type");l(this,"type_")}get product(){if(this.type!==p.ProductType)throw"product type was requested, but the type is not ProductType";return this.type_}set product(t){h(this,D,ce).call(this,p.ProductType,t)}get sum(){if(this.type!==p.SumType)throw"sum type was requested, but the type is not SumType";return this.type_}set sum(t){h(this,D,ce).call(this,p.SumType,t)}get array(){if(this.type!==p.ArrayType)throw"array type was requested, but the type is not ArrayType";return this.type_}set array(t){h(this,D,ce).call(this,p.ArrayType,t)}get map(){if(this.type!==p.MapType)throw"map type was requested, but the type is not MapType";return this.type_}set map(t){h(this,D,ce).call(this,p.MapType,t)}static createProductType(t){return h(this,k,x).call(this,p.ProductType,new _r(t))}static createSumType(t){return h(this,k,x).call(this,p.SumType,new Ur(t))}static createArrayType(t){return h(this,k,x).call(this,p.ArrayType,t)}static createMapType(t,i){return h(this,k,x).call(this,p.MapType,new Cr(t,i))}static createBoolType(){return h(this,k,x).call(this,p.Bool,null)}static createI8Type(){return h(this,k,x).call(this,p.I8,null)}static createU8Type(){return h(this,k,x).call(this,p.U8,null)}static createI16Type(){return h(this,k,x).call(this,p.I16,null)}static createU16Type(){return h(this,k,x).call(this,p.U16,null)}static createI32Type(){return h(this,k,x).call(this,p.I32,null)}static createU32Type(){return h(this,k,x).call(this,p.U32,null)}static createI64Type(){return h(this,k,x).call(this,p.I64,null)}static createU64Type(){return h(this,k,x).call(this,p.U64,null)}static createI128Type(){return h(this,k,x).call(this,p.I128,null)}static createU128Type(){return h(this,k,x).call(this,p.U128,null)}static createI256Type(){return h(this,k,x).call(this,p.I256,null)}static createU256Type(){return h(this,k,x).call(this,p.U256,null)}static createF32Type(){return h(this,k,x).call(this,p.F32,null)}static createF64Type(){return h(this,k,x).call(this,p.F64,null)}static createStringType(){return h(this,k,x).call(this,p.String,null)}static createBytesType(){return this.createArrayType(this.createU8Type())}static createOptionType(t){return this.createSumType([new z("some",t),new z("none",this.createProductType([]))])}static createIdentityType(){return this.createProductType([new o("__identity__",this.createU256Type())])}static createConnectionIdType(){return this.createProductType([new o("__connection_id__",this.createU128Type())])}static createScheduleAtType(){return vr.getAlgebraicType()}static createTimestampType(){return this.createProductType([new o("__timestamp_micros_since_unix_epoch__",this.createI64Type())])}static createTimeDurationType(){return this.createProductType([new o("__time_duration_micros__",this.createI64Type())])}isProductType(){return this.type===p.ProductType}isSumType(){return this.type===p.SumType}isArrayType(){return this.type===p.ArrayType}isMapType(){return this.type===p.MapType}isIdentity(){return h(this,D,Ye).call(this,"__identity__")}isConnectionId(){return h(this,D,Ye).call(this,"__connection_id__")}isScheduleAt(){return this.isSumType()&&this.sum.variants.length===2&&this.sum.variants[0].name==="Interval"&&this.sum.variants[0].algebraicType.type===p.U64&&this.sum.variants[1].name==="Time"&&this.sum.variants[1].algebraicType.type===p.U64}isTimestamp(){return h(this,D,Qe).call(this,"__timestamp_micros_since_unix_epoch__")}isTimeDuration(){return h(this,D,Qe).call(this,"__time_duration_micros__")}intoMapKey(t){switch(this.type){case p.U8:case p.U16:case p.U32:case p.U64:case p.U128:case p.U256:case p.I8:case p.I16:case p.I64:case p.I128:case p.F32:case p.F64:case p.String:case p.Bool:return t;case p.ProductType:return this.product.intoMapKey(t);default:const i=new ne(10);return this.serialize(i,t),i.toBase64()}}serialize(t,i){switch(this.type){case p.ProductType:this.product.serialize(t,i);break;case p.SumType:this.sum.serialize(t,i);break;case p.ArrayType:if(h(this,D,Xe).call(this))t.writeUInt8Array(i);else{const s=this.array;t.writeU32(i.length);for(let r of i)s.serialize(t,r)}break;case p.MapType:throw new Error("not implemented");case p.Bool:t.writeBool(i);break;case p.I8:t.writeI8(i);break;case p.U8:t.writeU8(i);break;case p.I16:t.writeI16(i);break;case p.U16:t.writeU16(i);break;case p.I32:t.writeI32(i);break;case p.U32:t.writeU32(i);break;case p.I64:t.writeI64(i);break;case p.U64:t.writeU64(i);break;case p.I128:t.writeI128(i);break;case p.U128:t.writeU128(i);break;case p.I256:t.writeI256(i);break;case p.U256:t.writeU256(i);break;case p.F32:t.writeF32(i);break;case p.F64:t.writeF64(i);break;case p.String:t.writeString(i);break;default:throw new Error(`not implemented, ${this.type}`)}}deserialize(t){switch(this.type){case p.ProductType:return this.product.deserialize(t);case p.SumType:return this.sum.deserialize(t);case p.ArrayType:if(h(this,D,Xe).call(this))return t.readUInt8Array();{const i=this.array,s=t.readU32();let r=[];for(let a=0;a<s;a++)r.push(i.deserialize(t));return r}case p.MapType:throw new Error("not implemented");case p.Bool:return t.readBool();case p.I8:return t.readI8();case p.U8:return t.readU8();case p.I16:return t.readI16();case p.U16:return t.readU16();case p.I32:return t.readI32();case p.U32:return t.readU32();case p.I64:return t.readI64();case p.U64:return t.readU64();case p.I128:return t.readI128();case p.U128:return t.readU128();case p.U256:return t.readU256();case p.F32:return t.readF32();case p.F64:return t.readF64();case p.String:return t.readString();default:throw new Error(`not implemented, ${this.type}`)}}},D=new WeakSet,ce=function(t,i){this.type_=i,this.type=i===void 0?p.None:t},k=new WeakSet,x=function(t,i){var r;let s=new ee;return h(r=s,D,ce).call(r,t,i),s},Xe=function(){return this.isArrayType()&&this.array.type==p.U8},Ye=function(t){return this.isProductType()&&this.product.elements.length===1&&(this.product.elements[0].algebraicType.type==p.U128||this.product.elements[0].algebraicType.type==p.U256)&&this.product.elements[0].name===t},Qe=function(t){return this.isProductType()&&this.product.elements.length===1&&this.product.elements[0].algebraicType.type===p.I64&&this.product.elements[0].name===t},A(ee,k),ee);(e=>{(t=>{t.SumType="SumType",t.ProductType="ProductType",t.ArrayType="ArrayType",t.MapType="MapType",t.Bool="Bool",t.I8="I8",t.U8="U8",t.I16="I16",t.U16="U16",t.I32="I32",t.U32="U32",t.I64="I64",t.U64="U64",t.I128="I128",t.U128="U128",t.I256="I256",t.U256="U256",t.F32="F32",t.F64="F64",t.String="String",t.None="None"})(e.Type||(e.Type={}))})(c);var p=c.Type;function Fr(e,t){const i=new pe(t);return e.deserialize(i)}var et;(e=>{e.FixedSize=r=>({tag:"FixedSize",value:r}),e.RowOffsets=r=>({tag:"RowOffsets",value:r});function t(){return c.createSumType([new z("FixedSize",c.createU16Type()),new z("RowOffsets",c.createArrayType(c.createU64Type()))])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(et||(et={}));var Se;(e=>{function t(){return c.createProductType([new o("sizeHint",et.getTypeScriptAlgebraicType()),new o("rowsData",c.createArrayType(c.createU8Type()))])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(Se||(Se={}));var tt;(e=>{function t(){return c.createProductType([new o("reducer",c.createStringType()),new o("args",c.createArrayType(c.createU8Type())),new o("requestId",c.createU32Type()),new o("flags",c.createU8Type())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(tt||(tt={}));var rt;(e=>{function t(){return c.createProductType([new o("queryStrings",c.createArrayType(c.createStringType())),new o("requestId",c.createU32Type())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(rt||(rt={}));var it;(e=>{function t(){return c.createProductType([new o("messageId",c.createArrayType(c.createU8Type())),new o("queryString",c.createStringType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(it||(it={}));var V;(e=>{function t(){return c.createProductType([new o("id",c.createU32Type())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(V||(V={}));var nt;(e=>{function t(){return c.createProductType([new o("query",c.createStringType()),new o("requestId",c.createU32Type()),new o("queryId",V.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(nt||(nt={}));var st;(e=>{function t(){return c.createProductType([new o("queryStrings",c.createArrayType(c.createStringType())),new o("requestId",c.createU32Type()),new o("queryId",V.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(st||(st={}));var at;(e=>{function t(){return c.createProductType([new o("requestId",c.createU32Type()),new o("queryId",V.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(at||(at={}));var ct;(e=>{function t(){return c.createProductType([new o("requestId",c.createU32Type()),new o("queryId",V.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(ct||(ct={}));var oe;(e=>{e.CallReducer=r=>({tag:"CallReducer",value:r}),e.Subscribe=r=>({tag:"Subscribe",value:r}),e.OneOffQuery=r=>({tag:"OneOffQuery",value:r}),e.SubscribeSingle=r=>({tag:"SubscribeSingle",value:r}),e.SubscribeMulti=r=>({tag:"SubscribeMulti",value:r}),e.Unsubscribe=r=>({tag:"Unsubscribe",value:r}),e.UnsubscribeMulti=r=>({tag:"UnsubscribeMulti",value:r});function t(){return c.createSumType([new z("CallReducer",tt.getTypeScriptAlgebraicType()),new z("Subscribe",rt.getTypeScriptAlgebraicType()),new z("OneOffQuery",it.getTypeScriptAlgebraicType()),new z("SubscribeSingle",nt.getTypeScriptAlgebraicType()),new z("SubscribeMulti",st.getTypeScriptAlgebraicType()),new z("Unsubscribe",at.getTypeScriptAlgebraicType()),new z("UnsubscribeMulti",ct.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(oe||(oe={}));var Ee;(e=>{function t(){return c.createProductType([new o("deletes",Se.getTypeScriptAlgebraicType()),new o("inserts",Se.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(Ee||(Ee={}));var ot;(e=>{e.Uncompressed=r=>({tag:"Uncompressed",value:r}),e.Brotli=r=>({tag:"Brotli",value:r}),e.Gzip=r=>({tag:"Gzip",value:r});function t(){return c.createSumType([new z("Uncompressed",Ee.getTypeScriptAlgebraicType()),new z("Brotli",c.createArrayType(c.createU8Type())),new z("Gzip",c.createArrayType(c.createU8Type()))])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(ot||(ot={}));var Oe;(e=>{function t(){return c.createProductType([new o("tableId",c.createU32Type()),new o("tableName",c.createStringType()),new o("numRows",c.createU64Type()),new o("updates",c.createArrayType(ot.getTypeScriptAlgebraicType()))])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(Oe||(Oe={}));var se;(e=>{function t(){return c.createProductType([new o("tables",c.createArrayType(Oe.getTypeScriptAlgebraicType()))])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(se||(se={}));var pt;(e=>{function t(){return c.createProductType([new o("databaseUpdate",se.getTypeScriptAlgebraicType()),new o("requestId",c.createU32Type()),new o("totalHostExecutionDuration",c.createTimeDurationType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(pt||(pt={}));var lt;(e=>{e.Committed=r=>({tag:"Committed",value:r}),e.Failed=r=>({tag:"Failed",value:r}),e.OutOfEnergy={tag:"OutOfEnergy"};function t(){return c.createSumType([new z("Committed",se.getTypeScriptAlgebraicType()),new z("Failed",c.createStringType()),new z("OutOfEnergy",c.createProductType([]))])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(lt||(lt={}));var ut;(e=>{function t(){return c.createProductType([new o("reducerName",c.createStringType()),new o("reducerId",c.createU32Type()),new o("args",c.createArrayType(c.createU8Type())),new o("requestId",c.createU32Type())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(ut||(ut={}));var yt;(e=>{function t(){return c.createProductType([new o("quanta",c.createU128Type())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(yt||(yt={}));var dt;(e=>{function t(){return c.createProductType([new o("status",lt.getTypeScriptAlgebraicType()),new o("timestamp",c.createTimestampType()),new o("callerIdentity",c.createIdentityType()),new o("callerConnectionId",c.createConnectionIdType()),new o("reducerCall",ut.getTypeScriptAlgebraicType()),new o("energyQuantaUsed",yt.getTypeScriptAlgebraicType()),new o("totalHostExecutionDuration",c.createTimeDurationType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(dt||(dt={}));var ht;(e=>{function t(){return c.createProductType([new o("requestId",c.createU32Type()),new o("update",se.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(ht||(ht={}));var gt;(e=>{function t(){return c.createProductType([new o("identity",c.createIdentityType()),new o("token",c.createStringType()),new o("connectionId",c.createConnectionIdType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(gt||(gt={}));var Tt;(e=>{function t(){return c.createProductType([new o("tableName",c.createStringType()),new o("rows",Se.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(Tt||(Tt={}));var bt;(e=>{function t(){return c.createProductType([new o("messageId",c.createArrayType(c.createU8Type())),new o("error",c.createOptionType(c.createStringType())),new o("tables",c.createArrayType(Tt.getTypeScriptAlgebraicType())),new o("totalHostExecutionDuration",c.createTimeDurationType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(bt||(bt={}));var qe;(e=>{function t(){return c.createProductType([new o("tableId",c.createU32Type()),new o("tableName",c.createStringType()),new o("tableRows",Oe.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(qe||(qe={}));var ft;(e=>{function t(){return c.createProductType([new o("requestId",c.createU32Type()),new o("totalHostExecutionDurationMicros",c.createU64Type()),new o("queryId",V.getTypeScriptAlgebraicType()),new o("rows",qe.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(ft||(ft={}));var mt;(e=>{function t(){return c.createProductType([new o("requestId",c.createU32Type()),new o("totalHostExecutionDurationMicros",c.createU64Type()),new o("queryId",V.getTypeScriptAlgebraicType()),new o("rows",qe.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(mt||(mt={}));var wt;(e=>{function t(){return c.createProductType([new o("totalHostExecutionDurationMicros",c.createU64Type()),new o("requestId",c.createOptionType(c.createU32Type())),new o("queryId",c.createOptionType(c.createU32Type())),new o("tableId",c.createOptionType(c.createU32Type())),new o("error",c.createStringType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(wt||(wt={}));var St;(e=>{function t(){return c.createProductType([new o("requestId",c.createU32Type()),new o("totalHostExecutionDurationMicros",c.createU64Type()),new o("queryId",V.getTypeScriptAlgebraicType()),new o("update",se.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(St||(St={}));var At;(e=>{function t(){return c.createProductType([new o("requestId",c.createU32Type()),new o("totalHostExecutionDurationMicros",c.createU64Type()),new o("queryId",V.getTypeScriptAlgebraicType()),new o("update",se.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(At||(At={}));var zt;(e=>{e.InitialSubscription=r=>({tag:"InitialSubscription",value:r}),e.TransactionUpdate=r=>({tag:"TransactionUpdate",value:r}),e.TransactionUpdateLight=r=>({tag:"TransactionUpdateLight",value:r}),e.IdentityToken=r=>({tag:"IdentityToken",value:r}),e.OneOffQueryResponse=r=>({tag:"OneOffQueryResponse",value:r}),e.SubscribeApplied=r=>({tag:"SubscribeApplied",value:r}),e.UnsubscribeApplied=r=>({tag:"UnsubscribeApplied",value:r}),e.SubscriptionError=r=>({tag:"SubscriptionError",value:r}),e.SubscribeMultiApplied=r=>({tag:"SubscribeMultiApplied",value:r}),e.UnsubscribeMultiApplied=r=>({tag:"UnsubscribeMultiApplied",value:r});function t(){return c.createSumType([new z("InitialSubscription",pt.getTypeScriptAlgebraicType()),new z("TransactionUpdate",dt.getTypeScriptAlgebraicType()),new z("TransactionUpdateLight",ht.getTypeScriptAlgebraicType()),new z("IdentityToken",gt.getTypeScriptAlgebraicType()),new z("OneOffQueryResponse",bt.getTypeScriptAlgebraicType()),new z("SubscribeApplied",ft.getTypeScriptAlgebraicType()),new z("UnsubscribeApplied",mt.getTypeScriptAlgebraicType()),new z("SubscriptionError",wt.getTypeScriptAlgebraicType()),new z("SubscribeMultiApplied",St.getTypeScriptAlgebraicType()),new z("UnsubscribeMultiApplied",At.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(zt||(zt={}));var te,Lt,Ke=(Lt=class{constructor(){A(this,te,new Map)}on(e,t){let i=n(this,te).get(e);i||(i=new Set,n(this,te).set(e,i)),i.add(t)}off(e,t){let i=n(this,te).get(e);i&&i.delete(t)}emit(e,...t){let i=n(this,te).get(e);if(i)for(let s of i)s(...t)}},te=new WeakMap,Lt),kr={component:"📦",info:"ℹ️",warn:"⚠️",error:"❌",debug:"🐛"},xr={component:"color: #fff; background-color: #8D6FDD; padding: 2px 5px; border-radius: 3px;",info:"color: #fff; background-color: #007bff; padding: 2px 5px; border-radius: 3px;",warn:"color: #fff; background-color: #ffc107; padding: 2px 5px; border-radius: 3px;",error:"color: #fff; background-color: #dc3545; padding: 2px 5px; border-radius: 3px;",debug:"color: #fff; background-color: #28a745; padding: 2px 5px; border-radius: 3px;"},Br={component:"color: #8D6FDD;",info:"color: #007bff;",warn:"color: #ffc107;",error:"color: #dc3545;",debug:"color: #28a745;"},Y=(e,t)=>{console.log(`%c${kr[e]} ${e.toUpperCase()}%c ${t}`,xr[e],Br[e])},Pr=class{constructor(e){l(this,"rows");l(this,"tableTypeInfo");l(this,"emitter");l(this,"applyOperations",(e,t)=>{const i=[];if(this.tableTypeInfo.primaryKeyInfo!==void 0){const s=new Map,r=new Map;for(const a of e)if(a.type==="insert"){const[g,u]=s.get(a.rowId)||[a,0];s.set(a.rowId,[a,u+1])}else{const[g,u]=r.get(a.rowId)||[a,0];r.set(a.rowId,[a,u+1])}for(const[a,[g,u]]of s){const y=r.get(a);if(y){const[b,S]=y,_=u-S,I=this.update(t,a,g.row,_);I&&i.push(I),r.delete(a)}else{const b=this.insert(t,g,u);b&&i.push(b)}}for(const[a,g]of r.values()){const u=this.delete(t,a,g);u&&i.push(u)}}else for(const s of e)if(s.type==="insert"){const r=this.insert(t,s);r&&i.push(r)}else{const r=this.delete(t,s);r&&i.push(r)}return i});l(this,"update",(e,t,i,s=0)=>{const r=this.rows.get(t);if(!r){Y("error",`Updating a row that was not present in the cache. Table: ${this.tableTypeInfo.tableName}, RowId: ${t}`);return}const[a,g]=r,u=Math.max(1,g+s);if(g+s<=0){Y("error",`Negative reference count for in table ${this.tableTypeInfo.tableName} row ${t} (${g} + ${s})`);return}return this.rows.set(t,[i,u]),g===0?(Y("error",`Updating a row id in table ${this.tableTypeInfo.tableName} which was not present in the cache (rowId: ${t})`),{type:"insert",table:this.tableTypeInfo.tableName,cb:()=>{this.emitter.emit("insert",e,i)}}):{type:"update",table:this.tableTypeInfo.tableName,cb:()=>{this.emitter.emit("update",e,a,i)}}});l(this,"insert",(e,t,i=1)=>{const[s,r]=this.rows.get(t.rowId)||[t.row,0];if(this.rows.set(t.rowId,[t.row,r+i]),r===0)return{type:"insert",table:this.tableTypeInfo.tableName,cb:()=>{this.emitter.emit("insert",e,t.row)}}});l(this,"delete",(e,t,i=1)=>{const[s,r]=this.rows.get(t.rowId)||[t.row,0];if(r===0){Y("warn","Deleting a row that was not present in the cache");return}if(r<=i)return this.rows.delete(t.rowId),{type:"delete",table:this.tableTypeInfo.tableName,cb:()=>{this.emitter.emit("delete",e,t.row)}};this.rows.set(t.rowId,[t.row,r-i])});l(this,"onInsert",e=>{this.emitter.on("insert",e)});l(this,"onDelete",e=>{this.emitter.on("delete",e)});l(this,"onUpdate",e=>{this.emitter.on("update",e)});l(this,"removeOnInsert",e=>{this.emitter.off("insert",e)});l(this,"removeOnDelete",e=>{this.emitter.off("delete",e)});l(this,"removeOnUpdate",e=>{this.emitter.off("update",e)});this.tableTypeInfo=e,this.rows=new Map,this.emitter=new Ke}count(){return this.rows.size}iter(){return Array.from(this.rows.values()).map(([e])=>e)}},Er=class{constructor(){l(this,"tables");this.tables=new Map}getTable(e){const t=this.tables.get(e);if(!t)throw console.error("The table has not been registered for this client. Please register the table before using it. If you have registered global tables using the SpacetimeDBClient.registerTables() or `registerTable()` method, please make sure that is executed first!"),new Error(`Table ${e} does not exist`);return t}getOrCreateTable(e){let t;return this.tables.has(e.tableName)?t=this.tables.get(e.tableName):(t=new Pr(e),this.tables.set(e.tableName,t)),t}};function Or(e,t){const i=Math.min(e.length,t.length);for(let s=0;s<i;s++){const r=e[s],a=t[s];if(r!==a)return typeof r=="number"&&typeof a=="number"?r-a:typeof r=="string"&&typeof a=="string"?r.localeCompare(a):typeof r=="string"?1:-1}return e.length-t.length}var Yt=class It{constructor(t,i,s,r=null,a=null){l(this,"major");l(this,"minor");l(this,"patch");l(this,"preRelease");l(this,"buildInfo");this.major=t,this.minor=i,this.patch=s,this.preRelease=r,this.buildInfo=a}toString(){let t=`${this.major}.${this.minor}.${this.patch}`;return this.preRelease&&(t+=`-${this.preRelease.join(".")}`),this.buildInfo&&(t+=`+${this.buildInfo}`),t}compare(t){return this.major!==t.major?this.major-t.major:this.minor!==t.minor?this.minor-t.minor:this.patch!==t.patch?this.patch-t.patch:this.preRelease&&t.preRelease?Or(this.preRelease,t.preRelease):this.preRelease||t.preRelease?-1:0}clone(){return new It(this.major,this.minor,this.patch,this.preRelease?[...this.preRelease]:null,this.buildInfo)}static parseVersionString(t){const i=/^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(?:-([\da-zA-Z-]+(?:\.[\da-zA-Z-]+)*))?(?:\+([\da-zA-Z-]+(?:\.[\da-zA-Z-]+)*))?$/,s=t.match(i);if(!s)throw new Error(`Invalid version string: ${t}`);const r=parseInt(s[1],10),a=parseInt(s[2],10),g=parseInt(s[3],10),u=s[4]?s[4].split(".").map(b=>isNaN(Number(b))?b:Number(b)):null,y=s[5]||null;return new It(r,a,g,u,y)}},Qt=new Yt(1,2,0);function qr(e){if(e===void 0)throw new Error(Mt(e));if(Yt.parseVersionString(e).compare(Qt)<0)throw new Error(Mt(e))}function Mt(e){return`Module code was generated with an incompatible version of the spacetimedb cli (${e}).  Update the cli version to at least ${Qt.toString()} and regenerate the bindings. You can upgrade to the latest cli version by running: spacetime version upgrade`}async function er(e,t,i=128*1024){let s=0;const r=new ReadableStream({pull(T){if(s<e.length){const m=e.subarray(s,Math.min(s+i,e.length));T.enqueue(m),s+=i}else T.close()}}),a=new DecompressionStream(t),u=r.pipeThrough(a).getReader(),y=[];let b=0,S;for(;!(S=await u.read()).done;)y.push(S.value),b+=S.value.length;const _=new Uint8Array(b);let I=0;for(const T of y)_.set(T,I),I+=T.length;return _}var le,Z,tr,rr,vt,ue,Mr=(ue=class{constructor(t){A(this,Z);l(this,"onclose");l(this,"onopen");l(this,"onmessage");l(this,"onerror");A(this,le);this.onmessage=void 0,this.onopen=void 0,this.onmessage=void 0,this.onerror=void 0,t.onmessage=h(this,Z,tr).bind(this),t.onerror=h(this,Z,vt).bind(this),t.onclose=h(this,Z,vt).bind(this),t.onopen=h(this,Z,rr).bind(this),t.binaryType="arraybuffer",d(this,le,t)}send(t){n(this,le).send(t)}close(){n(this,le).close()}static async createWebSocketFn({url:t,nameOrAddress:i,wsProtocol:s,authToken:r,compression:a,lightMode:g}){const u=new Headers;let y;y=WebSocket;let b;if(r){u.set("Authorization",`Bearer ${r}`);const I=new URL("v1/identity/websocket-token",t);I.protocol=t.protocol==="wss:"?"https:":"http:";const T=await fetch(I,{method:"POST",headers:u});if(T.ok){const{token:m}=await T.json();b=m}else return Promise.reject(new Error(`Failed to verify token: ${T.statusText}`))}const S=new URL(`v1/database/${i}/subscribe`,t);b&&S.searchParams.set("token",b),S.searchParams.set("compression",a==="gzip"?"Gzip":"None"),g&&S.searchParams.set("light","true");const _=new y(S.toString(),s);return new ue(_)}},le=new WeakMap,Z=new WeakSet,tr=async function(t){const i=new Uint8Array(t.data);let s;if(i[0]===0)s=i.slice(1);else{if(i[0]===1)throw new Error("Brotli Compression not supported. Please use gzip or none compression in withCompression method on DbConnection.");if(i[0]===2)s=await er(i.slice(1),"gzip");else throw new Error("Unexpected Compression Algorithm. Please use `gzip` or `none`")}this.onmessage?.({data:s})},rr=function(t){this.onopen?.(t)},vt=function(t){this.onerror?.(t)},ue),ye,de,$e,ze,re,Ie,ve,he,$t,Dr=($t=class{constructor(e,t){A(this,ye);A(this,de);A(this,$e);A(this,ze);A(this,re,new Ke);A(this,Ie,"gzip");A(this,ve,!1);A(this,he);this.remoteModule=e,this.dbConnectionConstructor=t,d(this,he,Mr.createWebSocketFn)}withUri(e){return d(this,ye,new URL(e)),this}withModuleName(e){return d(this,de,e),this}withToken(e){return d(this,ze,e),this}withWSFn(e){return d(this,he,e),this}withCompression(e){return d(this,Ie,e),this}withLightMode(e){return d(this,ve,e),this}onConnect(e){return n(this,re).on("connect",e),this}onConnectError(e){return n(this,re).on("connectError",e),this}onDisconnect(e){return n(this,re).on("disconnect",e),this}build(){if(!n(this,ye))throw new Error("URI is required to connect to SpacetimeDB");if(!n(this,de))throw new Error("Database name or address is required to connect to SpacetimeDB");return qr(this.remoteModule.versionInfo?.cliVersion),this.dbConnectionConstructor(new nr({uri:n(this,ye),nameOrAddress:n(this,de),identity:n(this,$e),token:n(this,ze),emitter:n(this,re),compression:n(this,Ie),lightMode:n(this,ve),createWSFn:n(this,he),remoteModule:this.remoteModule}))}},ye=new WeakMap,de=new WeakMap,$e=new WeakMap,ze=new WeakMap,re=new WeakMap,Ie=new WeakMap,ve=new WeakMap,he=new WeakMap,$t),Ue,_e,Ht,ir=(Ht=class{constructor(e){A(this,Ue);A(this,_e);this.db=e}onApplied(e){return d(this,Ue,e),this}onError(e){return d(this,_e,e),this}subscribe(e){const t=Array.isArray(e)?e:[e];if(t.length===0)throw new Error("Subscriptions must have at least one query");return new Nr(this.db,t,n(this,Ue),n(this,_e))}subscribeToAllTables(){this.subscribe("SELECT * FROM *")}},Ue=new WeakMap,_e=new WeakMap,Ht),Rr=class{constructor(){l(this,"subscriptions",new Map)}},ge,ie,J,G,X,Wt,Nr=(Wt=class{constructor(e,t,i,s){A(this,ge);A(this,ie,!1);A(this,J,!1);A(this,G,!1);A(this,X,new Ke);this.db=e,n(this,X).on("applied",r=>{d(this,G,!0),i&&i(r)}),n(this,X).on("error",(r,a)=>{d(this,G,!1),d(this,J,!0),s&&s(r,a)}),d(this,ge,this.db.registerSubscription(this,n(this,X),t))}unsubscribe(){if(n(this,ie))throw new Error("Unsubscribe has already been called");d(this,ie,!0),this.db.unregisterSubscription(n(this,ge)),n(this,X).on("end",e=>{d(this,J,!0),d(this,G,!1)})}unsubscribeThen(e){if(n(this,J))throw new Error("Subscription has already ended");if(n(this,ie))throw new Error("Unsubscribe has already been called");d(this,ie,!0),this.db.unregisterSubscription(n(this,ge)),n(this,X).on("end",t=>{d(this,J,!0),d(this,G,!1),e(t)})}isEnded(){return n(this,J)}isActive(){return n(this,G)}},ge=new WeakMap,ie=new WeakMap,J=new WeakMap,G=new WeakMap,X=new WeakMap,Wt);function Lr(e){switch(e){case"FullUpdate":return 0;case"NoSuccessNotify":return 1}}var Ce,M,Te,He,O,Fe,K,We,F,sr,Be,ar,Q,cr,or,$r,Hr,Wr,Kr,Vr,jr,Zr,Jr,Kt,nr=(Kt=class{constructor({uri:e,nameOrAddress:t,identity:i,token:s,emitter:r,remoteModule:a,createWSFn:g,compression:u,lightMode:y}){A(this,F);l(this,"isActive",!1);l(this,"identity");l(this,"token");l(this,"db");l(this,"reducers");l(this,"setReducerFlags");l(this,"connectionId",Je.random());A(this,Ce,0);A(this,M);A(this,Te,new Ke);A(this,He);A(this,O);A(this,Fe,Promise.resolve());A(this,K,new Rr);l(this,"clientCache");l(this,"ws");l(this,"wsPromise");A(this,We,()=>{const e=n(this,Ce);return d(this,Ce,n(this,Ce)+1),e});l(this,"subscriptionBuilder",()=>new ir(this));Y("info","Connecting to SpacetimeDB WS...");let b=new URL(e);/^wss?:/.test(e.protocol)||(b.protocol=b.protocol==="https:"?"wss:":"ws:"),this.identity=i,this.token=s,d(this,O,a),d(this,M,r);let S=this.connectionId.toHexString();b.searchParams.set("connection_id",S),this.clientCache=new Er,this.db=n(this,O).dbViewConstructor(this),this.setReducerFlags=n(this,O).setReducerFlagsConstructor(),this.reducers=n(this,O).reducersConstructor(this,this.setReducerFlags),this.wsPromise=g({url:b,nameOrAddress:t,wsProtocol:"v1.bsatn.spacetimedb",authToken:s,compression:u,lightMode:y}).then(_=>(this.ws=_,this.ws.onclose=()=>{n(this,M).emit("disconnect",this)},this.ws.onerror=I=>{n(this,M).emit("connectError",this,I)},this.ws.onopen=h(this,F,ar).bind(this),this.ws.onmessage=h(this,F,or).bind(this),_)).catch(_=>{Y("error","Error connecting to SpacetimeDB WS"),n(this,M).emit("connectError",this,_)})}registerSubscription(e,t,i){const s=n(this,We).call(this);return n(this,K).subscriptions.set(s,{handle:e,emitter:t}),h(this,F,Be).call(this,oe.SubscribeMulti({queryStrings:i,queryId:{id:s},requestId:0})),s}unregisterSubscription(e){h(this,F,Be).call(this,oe.UnsubscribeMulti({queryId:{id:e},requestId:0}))}callReducer(e,t,i){const s=oe.CallReducer({reducer:e,args:t,requestId:0,flags:Lr(i)});h(this,F,Be).call(this,s)}disconnect(){this.wsPromise.then(e=>{e&&e.close()})}onReducer(e,t){n(this,Te).on(e,t)}offReducer(e,t){n(this,Te).off(e,t)}},Ce=new WeakMap,M=new WeakMap,Te=new WeakMap,He=new WeakMap,O=new WeakMap,Fe=new WeakMap,K=new WeakMap,We=new WeakMap,F=new WeakSet,sr=async function(e){const t=(r,a,g)=>{const u=g.rowsData,y=new pe(u),b=[],S=n(this,O).tables[a].rowType,_=n(this,O).tables[a].primaryKeyInfo;for(;y.offset<u.length+u.byteOffset;){const I=y.offset,T=S.deserialize(y);let m;if(_!==void 0)m=_.colType.intoMapKey(T[_.colName]);else{const U=u.subarray(I-u.byteOffset,y.offset-u.byteOffset);m=Vt.fromByteArray(U)}b.push({type:r,rowId:m,row:T})}return b},i=async r=>{const a=r.tableName;let g=[];for(const u of r.updates){let y;if(u.tag==="Gzip"){const b=await er(u.value,"gzip");y=Ee.deserialize(new pe(b))}else{if(u.tag==="Brotli")throw new Error("Brotli compression not supported. Please use gzip or none compression in withCompression method on DbConnection.");y=u.value}g=g.concat(t("insert",a,y.inserts)),g=g.concat(t("delete",a,y.deletes))}return{tableName:a,operations:g}},s=async r=>{const a=[];for(const g of r.tables)a.push(await i(g));return a};switch(e.tag){case"InitialSubscription":{const r=e.value.databaseUpdate;return{tag:"InitialSubscription",tableUpdates:await s(r)}}case"TransactionUpdateLight":{const r=e.value.update;return{tag:"TransactionUpdateLight",tableUpdates:await s(r)}}case"TransactionUpdate":{const r=e.value,a=r.callerIdentity,g=Je.nullIfZero(r.callerConnectionId),u=r.reducerCall.reducerName,y=r.reducerCall.args,b=r.energyQuantaUsed;let S,_="";switch(r.status.tag){case"Committed":S=await s(r.status.value);break;case"Failed":S=[],_=r.status.value;break;case"OutOfEnergy":S=[];break}if(u==="<none>"){console.error(`Received an error from the database: ${_}`);return}let I;return u!==""&&(I={reducerName:u,args:y}),{tag:"TransactionUpdate",tableUpdates:S,identity:a,connectionId:g,reducerInfo:I,status:r.status,energyConsumed:b.quanta,message:_,timestamp:r.timestamp}}case"IdentityToken":return{tag:"IdentityToken",identity:e.value.identity,token:e.value.token,connectionId:e.value.connectionId};case"OneOffQueryResponse":throw new Error(`TypeScript SDK never sends one-off queries, but got OneOffQueryResponse ${e}`);case"SubscribeMultiApplied":{const r=await s(e.value.update);return{tag:"SubscribeApplied",queryId:e.value.queryId.id,tableUpdates:r}}case"UnsubscribeMultiApplied":{const r=await s(e.value.update);return{tag:"UnsubscribeApplied",queryId:e.value.queryId.id,tableUpdates:r}}case"SubscriptionError":return{tag:"SubscriptionError",queryId:e.value.queryId,error:e.value.error}}},Be=function(e){this.wsPromise.then(t=>{if(t){const i=new ne(1024);oe.serialize(i,e);const s=i.getBuffer();t.send(s)}})},ar=function(){this.isActive=!0},Q=function(e,t){let i=[];for(let s of e){const r=s.tableName,a=n(this,O).tables[r],u=this.clientCache.getOrCreateTable(a).applyOperations(s.operations,t);for(const y of u)i.push(y)}return i},cr=async function(e){var s;const t=Fr(zt,e),i=await h(this,F,sr).call(this,t);if(i)switch(i.tag){case"InitialSubscription":{let r={tag:"SubscribeApplied"};const a=n(this,O).eventContextConstructor(this,r),{event:g,...u}=a,y=h(this,F,Q).call(this,i.tableUpdates,a);n(this,M)&&((s=n(this,He))==null||s.call(this,u));for(const b of y)b.cb();break}case"TransactionUpdateLight":{let r={tag:"UnknownTransaction"};const a=n(this,O).eventContextConstructor(this,r),g=h(this,F,Q).call(this,i.tableUpdates,a);for(const u of g)u.cb();break}case"TransactionUpdate":{let r=i.reducerInfo,a=!1,g,u;if(!r)a=!0;else{u=n(this,O).reducers[r.reducerName];try{const m=new pe(r.args);g=u.argsType.deserialize(m)}catch{console.debug("Failed to deserialize reducer arguments"),a=!0}}if(a){const m={tag:"UnknownTransaction"},U=n(this,O).eventContextConstructor(this,m),E=h(this,F,Q).call(this,i.tableUpdates,U);for(const R of E)R.cb();return}r=r,u=u;const y={callerIdentity:i.identity,status:i.status,callerConnectionId:i.connectionId,timestamp:i.timestamp,energyConsumed:i.energyConsumed,reducer:{name:r.reducerName,args:g}},b={tag:"Reducer",value:y},S=n(this,O).eventContextConstructor(this,b),_={...S,event:y},I=h(this,F,Q).call(this,i.tableUpdates,S),T=[];u.argsType.product.elements.forEach((m,U)=>{T.push(g[m.name])}),n(this,Te).emit(r.reducerName,_,...T);for(const m of I)m.cb();break}case"IdentityToken":{this.identity=i.identity,!this.token&&i.token&&(this.token=i.token),this.connectionId=i.connectionId,n(this,M).emit("connect",this,this.identity,this.token);break}case"SubscribeApplied":{const r=n(this,K).subscriptions.get(i.queryId);if(r===void 0){Y("error",`Received SubscribeApplied for unknown queryId ${i.queryId}.`);break}const a={tag:"SubscribeApplied"},g=n(this,O).eventContextConstructor(this,a),{event:u,...y}=g,b=h(this,F,Q).call(this,i.tableUpdates,g);r?.emitter.emit("applied",y);for(const S of b)S.cb();break}case"UnsubscribeApplied":{const r=n(this,K).subscriptions.get(i.queryId);if(r===void 0){Y("error",`Received UnsubscribeApplied for unknown queryId ${i.queryId}.`);break}const a={tag:"UnsubscribeApplied"},g=n(this,O).eventContextConstructor(this,a),{event:u,...y}=g,b=h(this,F,Q).call(this,i.tableUpdates,g);r?.emitter.emit("end",y),n(this,K).subscriptions.delete(i.queryId);for(const S of b)S.cb();break}case"SubscriptionError":{const r=Error(i.error),a={tag:"Error",value:r},u={...n(this,O).eventContextConstructor(this,a),event:r};i.queryId!==void 0?(n(this,K).subscriptions.get(i.queryId)?.emitter.emit("error",u,r),n(this,K).subscriptions.delete(i.queryId)):(console.error("Received an error message without a queryId: ",r),n(this,K).subscriptions.forEach(({emitter:y})=>{y.emit("error",u,r)}))}}},or=function(e){d(this,Fe,n(this,Fe).then(()=>h(this,F,cr).call(this,e.data)))},$r=function(e,t){n(this,M).on(e,t)},Hr=function(e,t){n(this,M).off(e,t)},Wr=function(e){n(this,M).on("connect",e)},Kr=function(e){n(this,M).on("disconnect",e)},Vr=function(e){n(this,M).on("connectError",e)},jr=function(e){n(this,M).off("connect",e)},Zr=function(e){n(this,M).off("disconnect",e)},Jr=function(e){n(this,M).off("connectError",e)},Kt),Ut;(e=>{function t(){return c.createProductType([new o("id",c.createU32Type()),new o("energy",c.createU32Type()),new o("color",c.createU32Type())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(Ut||(Ut={}));var _t;(e=>{e.Put=r=>({tag:"Put",value:r}),e.Delete={tag:"Delete"},e.Move={tag:"Move"};function t(){return c.createSumType([new z("Put",Ut.getTypeScriptAlgebraicType()),new z("Delete",c.createProductType([])),new z("Move",c.createProductType([]))])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(_t||(_t={}));var Me;(e=>{function t(){return c.createProductType([new o("typ",_t.getTypeScriptAlgebraicType()),new o("player",c.createU32Type()),new o("pos",c.createU32Type()),new o("id",c.createU32Type())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(Me||(Me={}));var Ae;(e=>{function t(){return c.createProductType([new o("id",c.createU64Type()),new o("scheduledAt",c.createScheduleAtType()),new o("action",Me.getTypeScriptAlgebraicType()),new o("sender",c.createIdentityType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(Ae||(Ae={}));var De;(e=>{function t(){return c.createProductType([new o("args",Ae.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(De||(De={}));var Re;(e=>{function t(){return c.createProductType([new o("action",Me.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(Re||(Re={}));var Ct;(e=>{function t(){return c.createProductType([])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(Ct||(Ct={}));class Gr{constructor(t){l(this,"tableCache");l(this,"conn",{find:t=>{for(let i of this.tableCache.iter())if(be(i.conn,t))return i}});l(this,"id",{find:t=>{for(let i of this.tableCache.iter())if(be(i.id,t))return i}});l(this,"onInsert",t=>this.tableCache.onInsert(t));l(this,"removeOnInsert",t=>this.tableCache.removeOnInsert(t));l(this,"onDelete",t=>this.tableCache.onDelete(t));l(this,"removeOnDelete",t=>this.tableCache.removeOnDelete(t));l(this,"onUpdate",t=>this.tableCache.onUpdate(t));l(this,"removeOnUpdate",t=>this.tableCache.removeOnUpdate(t));this.tableCache=t}count(){return this.tableCache.count()}iter(){return this.tableCache.iter()}}class Xr{constructor(t){l(this,"tableCache");l(this,"id",{find:t=>{for(let i of this.tableCache.iter())if(be(i.id,t))return i}});l(this,"onInsert",t=>this.tableCache.onInsert(t));l(this,"removeOnInsert",t=>this.tableCache.removeOnInsert(t));l(this,"onDelete",t=>this.tableCache.onDelete(t));l(this,"removeOnDelete",t=>this.tableCache.removeOnDelete(t));l(this,"onUpdate",t=>this.tableCache.onUpdate(t));l(this,"removeOnUpdate",t=>this.tableCache.removeOnUpdate(t));this.tableCache=t}count(){return this.tableCache.count()}iter(){return this.tableCache.iter()}}class Yr{constructor(t){l(this,"tableCache");l(this,"pos",{find:t=>{for(let i of this.tableCache.iter())if(be(i.pos,t))return i}});l(this,"id",{find:t=>{for(let i of this.tableCache.iter())if(be(i.id,t))return i}});l(this,"onInsert",t=>this.tableCache.onInsert(t));l(this,"removeOnInsert",t=>this.tableCache.removeOnInsert(t));l(this,"onDelete",t=>this.tableCache.onDelete(t));l(this,"removeOnDelete",t=>this.tableCache.removeOnDelete(t));l(this,"onUpdate",t=>this.tableCache.onUpdate(t));l(this,"removeOnUpdate",t=>this.tableCache.removeOnUpdate(t));this.tableCache=t}count(){return this.tableCache.count()}iter(){return this.tableCache.iter()}}var Ft;(e=>{e.Ok={tag:"Ok"},e.Err=r=>({tag:"Err",value:r});function t(){return c.createSumType([new z("Ok",c.createProductType([])),new z("Err",c.createStringType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(Ft||(Ft={}));var kt;(e=>{function t(){return c.createProductType([new o("id",c.createU32Type()),new o("result",Ft.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(kt||(kt={}));var Ne;(e=>{function t(){return c.createProductType([new o("conn",c.createIdentityType()),new o("id",c.createU64Type()),new o("bodytile",c.createU32Type()),new o("result",c.createOptionType(kt.getTypeScriptAlgebraicType()))])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(Ne||(Ne={}));var Le;(e=>{function t(){return c.createProductType([new o("pos",c.createU32Type()),new o("color",c.createU32Type()),new o("id",c.createU32Type()),new o("owner",c.createU64Type()),new o("lastAction",c.createTimestampType()),new o("energy",c.createU32Type())])}e.getTypeScriptAlgebraicType=t;function i(r,a){e.getTypeScriptAlgebraicType().serialize(r,a)}e.serialize=i;function s(r){return e.getTypeScriptAlgebraicType().deserialize(r)}e.deserialize=s})(Le||(Le={}));const Pe={tables:{person:{tableName:"person",rowType:Ne.getTypeScriptAlgebraicType(),primaryKey:"conn",primaryKeyInfo:{colName:"conn",colType:Ne.getTypeScriptAlgebraicType().product.elements[0].algebraicType}},scheduled_action:{tableName:"scheduled_action",rowType:Ae.getTypeScriptAlgebraicType(),primaryKey:"id",primaryKeyInfo:{colName:"id",colType:Ae.getTypeScriptAlgebraicType().product.elements[0].algebraicType}},tile:{tableName:"tile",rowType:Le.getTypeScriptAlgebraicType(),primaryKey:"pos",primaryKeyInfo:{colName:"pos",colType:Le.getTypeScriptAlgebraicType().product.elements[0].algebraicType}}},reducers:{invoke_scheduled:{reducerName:"invoke_scheduled",argsType:De.getTypeScriptAlgebraicType()},request_action:{reducerName:"request_action",argsType:Re.getTypeScriptAlgebraicType()},spawn:{reducerName:"spawn",argsType:Ct.getTypeScriptAlgebraicType()}},versionInfo:{cliVersion:"1.2.0"},eventContextConstructor:(e,t)=>({...e,event:t}),dbViewConstructor:e=>new ti(e),reducersConstructor:(e,t)=>new Qr(e,t),setReducerFlagsConstructor:()=>new ei};class Qr{constructor(t,i){this.connection=t,this.setCallReducerFlags=i}invokeScheduled(t){const i={args:t};let s=new ne(1024);De.getTypeScriptAlgebraicType().serialize(s,i);let r=s.getBuffer();this.connection.callReducer("invoke_scheduled",r,this.setCallReducerFlags.invokeScheduledFlags)}onInvokeScheduled(t){this.connection.onReducer("invoke_scheduled",t)}removeOnInvokeScheduled(t){this.connection.offReducer("invoke_scheduled",t)}requestAction(t){const i={action:t};let s=new ne(1024);Re.getTypeScriptAlgebraicType().serialize(s,i);let r=s.getBuffer();this.connection.callReducer("request_action",r,this.setCallReducerFlags.requestActionFlags)}onRequestAction(t){this.connection.onReducer("request_action",t)}removeOnRequestAction(t){this.connection.offReducer("request_action",t)}spawn(){this.connection.callReducer("spawn",new Uint8Array(0),this.setCallReducerFlags.spawnFlags)}onSpawn(t){this.connection.onReducer("spawn",t)}removeOnSpawn(t){this.connection.offReducer("spawn",t)}}class ei{constructor(){l(this,"invokeScheduledFlags","FullUpdate");l(this,"requestActionFlags","FullUpdate");l(this,"spawnFlags","FullUpdate")}invokeScheduled(t){this.invokeScheduledFlags=t}requestAction(t){this.requestActionFlags=t}spawn(t){this.spawnFlags=t}}class ti{constructor(t){this.connection=t}get person(){return new Gr(this.connection.clientCache.getOrCreateTable(Pe.tables.person))}get scheduledAction(){return new Xr(this.connection.clientCache.getOrCreateTable(Pe.tables.scheduled_action))}get tile(){return new Yr(this.connection.clientCache.getOrCreateTable(Pe.tables.tile))}}class ri extends ir{}class pr extends nr{constructor(){super(...arguments);l(this,"subscriptionBuilder",()=>new ri(this))}}l(pr,"builder",()=>new Dr(Pe,i=>i));const ii=`




type Color = [number,number,number]

type Block = {
  alive: boolean
  move:(pos:Pos)=>Promise<Block>
  del:(pos:Pos)=>Promise<void>
  put:(pos:Pos, color:Color, energy?:number) => Promise<Block>

  energy: number
  pos: Pos
  id: number
  color: Color
}
type Pos = [number, number]

type State = {
  world: {
    pixels: (null | Block)[][];
    subscribe: (fn: (focus: Pos | undefined) => void) => () => void;
    getPixel: (pos: Pos) => Block | null;
  };
  keyboard: {
    isPressed: (key: string) => boolean;
    subscribe: (fn: (key: string) => void) => () => void;
  };
};


type UserAction = {
  type:"Move" | "Delete"
  pos: Pos
} | {
  type:"Put"
  pos: Pos
  color: Color
  energy: number
}



function main(state:State, player:Block){

  state.keyboard.subscribe(e=>{
    console.log(e)
    let x = 0
    let y = 0
    if (e=="ArrowUp") y -= 1
    if (e=="ArrowDown") y += 1
    if (e=="ArrowLeft") x -= 1
    if (e=="ArrowRight") x += 1

    target = [player.pos[0] + x, player.pos[1] + y]

    player.move(target)
    

  })

}





`;async function ni(){const e=new Bt("UserScript",ii);return console.log(e.value),Function(e.value+"return main")()}const fe=128,je=e=>e[0]+e[1]*fe,si=e=>(e[0]<<16)+(e[1]<<8)+e[2],ai=e=>{e>>=8;let t=e&255;e>>=8;let i=e&255;return e>>=8,[e&255,i,t]},W=e=>[e%fe,Math.floor(e/fe)];function ci(e){let t=0;const i=r=>{let a=Math.round(Math.random()*1073741824);const g={move:u=>e({typ:{tag:"Move"},pos:je(u),id:t++,player:r.id}).then(()=>{let y=s.getPixel(u);if(!y)throw new Error("new Block not found");return g.pos=y.pos,g.energy=y.energy,y}),del:u=>e({typ:{tag:"Delete"},pos:je(u),id:t++,player:r.id}),put:(u,y,b)=>e({typ:{tag:"Put",value:{energy:b??0,color:si(y),id:a}},pos:je(u),id:t++,player:r.id}).then(()=>{let S=s.getPixel(u);if(!S)throw new Error("new Block not found");return S}),alive:!0,color:ai(r.color),energy:r.energy,pos:W(r.pos),id:r.id};return g};let s=(()=>{const r=Array.from({length:fe},()=>Array.from({length:fe},()=>null)),a=new Set,g=u=>{a.forEach(y=>y(u))};return{pixels:r,subscribe:u=>(a.add(u),()=>a.delete(u)),setPixel:(u,y)=>{r[u[0]][u[1]]=y?i(y):null,g(u)},getPixel:u=>r[u[0]][u[1]]}})();return{world:s,keyboard:(()=>{const r=new Map,a=new Set,g=(y,b)=>{r.set(y,b),b&&u(y)},u=y=>{a.forEach(b=>b(y))};return window.addEventListener("keydown",y=>g(y.key,!0)),window.addEventListener("keyup",y=>g(y.key,!1)),{isPressed:y=>r.get(y)??!1,subscribe:y=>(a.add(y),()=>a.delete(y))}})()}}const lr=document.querySelector("#app"),ur="pixel",Pt=new Bt("servermode","remote");Pt.set(window.location.pathname.split("/").includes("local")?"local":"remote");const oi=Pt.value=="local"?"ws://localhost:3000":"wss://maincloud.spacetimedb.com",Dt=new Bt(ur+Pt.value+"-token","");pr.builder().withUri(oi).withModuleName(ur).withToken(Dt.value).onConnect((e,t,i)=>{Dt.set(i);let s=new Map;const r=a=>{let g=a.result;if(!g)return;let u=s.get(g.id);u&&u(g.result)};e.subscriptionBuilder().onApplied(a=>{let g=a.db.person.conn.find(t),y=ci(b=>new Promise((S,_)=>{s.set(b.id,I=>{I.tag=="Ok"?S():_(I.value)}),e.reducers.requestAction(b)}));a.db.person.onInsert((b,S)=>r(S)),a.db.person.onUpdate((b,S,_)=>r(_)),e.subscriptionBuilder().onApplied(b=>{for(let I of b.db.tile.iter())y.world.setPixel(W(I.pos),I);b.db.tile.onInsert((I,T)=>{y.world.setPixel(W(T.pos),T),Ze(y.world.pixels)}),b.db.tile.onUpdate((I,T,m)=>{let U=y.world.getPixel(W(T.pos));U.pos=W(m.pos),console.log(U.pos),U.energy=m.energy,y.world.setPixel(W(T.pos),null),y.world.setPixel(W(m.pos),m),Ze(y.world.pixels)}),b.db.tile.onDelete((I,T)=>{y.world.getPixel(W(T.pos)).alive=!1,y.world.setPixel(W(T.pos),null),Ze(y.world.pixels)});let S=e.db.tile.id.find(g.bodytile)?.pos;if(!S)throw new Error("no body found");let _=y.world.getPixel(W(S));ni().then(I=>{console.log(I),I(y,_)})}).onError(console.error).subscribe("SELECT * FROM tile")}).onError(console.error).subscribe(`SELECT * FROM person WHERE conn == '${t.toHexString()}'`)}).onConnectError(e=>console.error(e)).build();function pi(e){const t=document.createElement("button");return t.innerText=e,lr.appendChild(t),t}const Et=pi("Show Code"),ae=document.createElement("canvas"),yr=Math.min(window.innerWidth,window.innerHeight)-Et.clientHeight-10;ae.width=yr;ae.height=yr;lr.appendChild(ae);const xt=ae.getContext("2d"),li=document.addEventListener.bind(document);Et.onclick=()=>{window.location.pathname=window.location.pathname.split("/").filter(e=>e!="local").join("/")+"editor"};li("keyup",e=>{(e.key==="Escape"||e.key=="Tab")&&Et.click()});const ke=ae.width/fe;function ui(e,t,i){xt.fillStyle=i,xt.fillRect(e*ke,t*ke,ke,ke)}function Ze(e){xt.clearRect(0,0,ae.width,ae.height),e.forEach((t,i)=>t.forEach((s,r)=>{s!==null&&ui(i,r,`rgb(${s.color[0]}, ${s.color[1]}, ${s.color[2]})`)}))}
